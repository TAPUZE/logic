<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מבחן אבחון אינטראקטיבי במתמטיקה (משופר)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            color: #1e293b; /* slate-800 */
        }
        .container-quiz {
            max-width: 700px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .question-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 0.5rem;
            background-color: #f8fafc; /* slate-50 */
        }
        .problem-statement {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            color: #0f172a; /* slate-900 */
            margin-bottom: 1rem;
        }
        .question-text {
            font-size: 1.1rem; /* Equivalent to text-lg approx */
            color: #334155; /* slate-700 */
            margin-bottom: 0.75rem;
        }
        label.option-label {
            display: block;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #fff;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        label.option-label:hover {
            background-color: #f1f5f9; /* slate-100 */
            border-color: #94a3b8; /* slate-400 */
        }
        input[type="radio"] {
            margin-left: 0.5rem; /* For RTL */
            accent-color: #2563eb; /* blue-600 */
        }
        button.submit-button {
            padding: 0.75rem 1.5rem;
            background-color: #2563eb; /* blue-600 */
            color: white;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* medium */
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }
        button.submit-button:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        button.action-button {
            padding: 0.5rem 1rem;
            background-color: #475569; /* slate-600 */
            color: white;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* medium */
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 0.5rem; /* Space between buttons for RTL */
        }
        button.action-button:hover {
            background-color: #334155; /* slate-700 */
        }
        .feedback-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background-color: #eff6ff; /* blue-50 */
            color: #1e40af; /* blue-800 */
            border: 1px solid #bfdbfe; /* blue-200 */
        }
        .hidden {
            display: none;
        }
        
        /* Styles for printable report */
        #printableReport {
            display: none; /* Hidden by default */
            padding: 20px;
            font-family: 'Assistant', sans-serif;
            color: #000; /* Black text for printing */
            direction: rtl; /* Ensure report is RTL */
        }
        #printableReport h2, #printableReport h3 {
            font-weight: 600;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ccc;
            padding-bottom: 0.5rem;
        }
        #printableReport h2 { font-size: 1.5rem; }
        #printableReport h3 { font-size: 1.3rem; margin-top: 1.5rem;}

        #printableReport .report-item {
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px dotted #eee;
        }
         #printableReport .report-item:last-child {
            border-bottom: none;
        }
        #printableReport p {
            margin-bottom: 0.25rem;
        }
        #printableReport strong {
            font-weight: 600;
        }
        #printableReport ul {
            list-style-type: disc;
            margin-right: 20px; /* Indentation for RTL */
            padding-right: 20px;
        }
        #printableReport li {
            margin-bottom: 0.25rem;
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #printableReport, #printableReport * {
                visibility: visible;
            }
            #printableReport {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block !important;
                font-size: 12pt;
            }
             .container-quiz > h1, 
             .container-quiz > div:first-of-type, /* Action buttons container */
             .question-section, 
             .feedback-section {
                display: none !important;
                visibility: hidden !important;
            }
        }
    </style>
    <script>
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container-quiz">
        <h1 class="text-2xl font-bold text-center text-slate-700 mb-6">מבחן אבחון אינטראקטיבי במתמטיקה</h1>

        <div class="mb-6 text-center">
            <button class="action-button" onclick="startOver()">התחל מחדש</button>
            <button class="action-button" onclick="shareReport()">שתף דוח</button>
        </div>

        <div id="mainProblemSection" class="question-section">
            <p class="problem-statement">בעיה ראשית:</p>
            <p class="question-text">פתור את המשוואה הבאה עבור $x$: $3(x-2) + 5 = 2x - 1$</p>
            <p class="text-sm text-slate-500 mb-3">אנא פתור זאת במחברתך תחילה, ולאחר מכן בחר את תשובתך הסופית למטה.</p>
            
            <div id="mainProblemOptions">
                <label class="option-label"><input type="radio" name="mainAnswer" value="0"> א) $x = 0$</label>
                <label class="option-label"><input type="radio" name="mainAnswer" value="-4"> ב) $x = -4$</label>
                <label class="option-label"><input type="radio" name="mainAnswer" value="2"> ג) $x = 2$</label>
                <label class="option-label"><input type="radio" name="mainAnswer" value="6"> ד) $x = 6$</label>
            </div>
            <button class="submit-button" onclick="checkMainAnswer()">הגש תשובה</button>
        </div>

        <div id="diagnosticQ1Section" class="question-section hidden">
            <p class="problem-statement">בוא נפרק את זה. שלב 1: פתיחת סוגריים (חוק הפילוג)</p>
            <p class="question-text">התבונן בחלק $3(x-2)$ מהמשוואה המקורית. למה ביטוי זה שווה לאחר פתיחת סוגריים?</p>
            <div id="diagnosticQ1Options">
                <label class="option-label"><input type="radio" name="diagQ1Answer" value="3x-6"> א) $3x - 6$</label>
                <label class="option-label"><input type="radio" name="diagQ1Answer" value="3x-2"> ב) $3x - 2$ (שכחת להכפיל 3 ב-2-)</label>
                <label class="option-label"><input type="radio" name="diagQ1Answer" value="3x+6"> ג) $3x + 6$ (טעות בסימן של $3 \times -2$)</label>
                <label class="option-label"><input type="radio" name="diagQ1Answer" value="x-6"> ד) $x - 6$ (שכחת להכפיל 3 ב-$x$)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQ1()">הגש תשובה לשלב 1</button>
        </div>

        <div id="diagnosticQ1_sub_multiplyConstant" class="question-section hidden">
            <p class="problem-statement">פירוק נוסף לשלב 1: $3(x-2)$</p>
            <p class="question-text">בביטוי $3(x-2)$, נראה שהכפלת נכון $3 \times x = 3x$. <br>כעת, מה התוצאה של החלק השני של הפילוג: $3 \times (-2)$?</p>
            <div id="diagnosticQ1_sub_multiplyConstantOptions">
                <label class="option-label"><input type="radio" name="diagQ1_sub_mc_Answer" value="-6"> א) $-6$</label>
                <label class="option-label"><input type="radio" name="diagQ1_sub_mc_Answer" value="6"> ב) $6$</label>
                <label class="option-label"><input type="radio" name="diagQ1_sub_mc_Answer" value="-2"> ג) $-2$ (זהו המספר עצמו, לא תוצאת הכפל)</label>
                 <label class="option-label"><input type="radio" name="diagQ1_sub_mc_Answer" value="1"> ד) $1$ ($3-2=1$)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQ1_sub_multiplyConstant()">הגש תשובה</button>
        </div>

        <div id="diagnosticQ1_sub_signRule" class="question-section hidden">
            <p class="problem-statement">פירוק נוסף לשלב 1: $3(x-2)$ - כלל הסימנים</p>
            <p class="question-text">בביטוי $3(x-2)$, אתה מכפיל $3$ ב-$x$ (שזה $3x$) וגם $3$ ב-$-2$.<br>כאשר מכפילים מספר חיובי במספר שלילי (כמו $3 \times -2$), מה הסימן של התוצאה?</p>
            <div id="diagnosticQ1_sub_signRuleOptions">
                <label class="option-label"><input type="radio" name="diagQ1_sub_sr_Answer" value="negative"> א) שלילי</label>
                <label class="option-label"><input type="radio" name="diagQ1_sub_sr_Answer" value="positive"> ב) חיובי</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQ1_sub_signRule()">הגש תשובה</button>
        </div>
         <div id="diagnosticQ1_sub_signRule_apply" class="question-section hidden">
            <p class="problem-statement">יישום כלל הסימנים</p>
            <p class="question-text">אוקיי, אם התוצאה של חיובי כפול שלילי היא שלילית, אז למה שווה $3 \times (-2)$?</p>
            <div id="diagnosticQ1_sub_signRule_applyOptions">
                <label class="option-label"><input type="radio" name="diagQ1_sub_sra_Answer" value="-6"> א) $-6$</label>
                <label class="option-label"><input type="radio" name="diagQ1_sub_sra_Answer" value="6"> ב) $6$</label>
                 <label class="option-label"><input type="radio" name="diagQ1_sub_sra_Answer" value="5"> ג) $5$</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQ1_sub_signRule_apply()">הגש תשובה</button>
        </div>


        <div id="diagnosticQ1_sub_multiplyVariable" class="question-section hidden">
            <p class="problem-statement">פירוק נוסף לשלב 1: $3(x-2)$</p>
            <p class="question-text">בביטוי $3(x-2)$, נראה שהכפלת נכון $3 \times (-2) = -6$. <br>כעת, מה התוצאה של החלק הראשון של הפילוג: $3 \times x$?</p>
            <div id="diagnosticQ1_sub_multiplyVariableOptions">
                <label class="option-label"><input type="radio" name="diagQ1_sub_mv_Answer" value="3x"> א) $3x$</label>
                <label class="option-label"><input type="radio" name="diagQ1_sub_mv_Answer" value="x"> ב) $x$ (זהו המשתנה עצמו, לא תוצאת הכפל)</label>
                <label class="option-label"><input type="radio" name="diagQ1_sub_mv_Answer" value="3"> ג) $3$ (זהו המספר עצמו, לא תוצאת הכפל)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQ1_sub_multiplyVariable()">הגש תשובה</button>
        </div>

        <div id="diagnosticQ2Section" class="question-section hidden">
            <p class="problem-statement">שלב 2: כינוס איברים באגף אחד</p>
            <p class="question-text">אם $3(x-2)$ אכן שווה ל-$3x-6$, אז האגף השמאלי של המשוואה המקורית ($3(x-2)+5$) הופך ל-$3x-6+5$. למה שווה הביטוי $3x-6+5$ לאחר כינוס איברים?</p>
            <div id="diagnosticQ2Options">
                <label class="option-label"><input type="radio" name="diagQ2Answer" value="3x-1"> א) $3x - 1$</label>
                <label class="option-label"><input type="radio" name="diagQ2Answer" value="3x+11"> ב) $3x + 11$</label>
                <label class="option-label"><input type="radio" name="diagQ2Answer" value="2x"> ג) $2x$</label> 
                <label class="option-label"><input type="radio" name="diagQ2Answer" value="3x+1"> ד) $3x + 1$</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQ2()">הגש תשובה לשלב 2</button>
        </div>

        <div id="diagnosticQ3Section" class="question-section hidden">
            <p class="problem-statement">שלב 3: העברת אגפים - משתנים</p>
            <p class="question-text">עד כה, יש לנו $3x-1 = 2x-1$. כדי לרכז את האיברים עם $x$ באגף אחד, מה התוצאה של חיסור $2x$ משני אגפי המשוואה?</p>
             <div id="diagnosticQ3Options">
                <label class="option-label"><input type="radio" name="diagQ3Answer" value="x-1 = -1"> א) $x - 1 = -1$</label>
                <label class="option-label"><input type="radio" name="diagQ3Answer" value="5x-1 = -1"> ב) $5x - 1 = -1$</label>
                <label class="option-label"><input type="radio" name="diagQ3Answer" value="x-1 = 2x-1-2x"> ג) $x-1 = 2x-1-2x$ (פישוט לא נכון של אגף ימין)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQ3()">הגש תשובה לשלב 3</button>
        </div>

        <div id="diagnosticQ4Section" class="question-section hidden">
            <p class="problem-statement">שלב 4: בידוד המשתנה</p>
            <p class="question-text">יש לנו $x-1 = -1$. כדי לפתור עבור $x$, מה התוצאה של הוספת 1 לשני אגפי המשוואה?</p>
             <div id="diagnosticQ4Options">
                <label class="option-label"><input type="radio" name="diagQ4Answer" value="x = 0"> א) $x = 0$</label>
                <label class="option-label"><input type="radio" name="diagQ4Answer" value="x = -2"> ב) $x = -2$</label>
                <label class="option-label"><input type="radio" name="diagQ4Answer" value="x = 1"> ג) $x = 1$</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQ4()">הגש תשובה לשלב 4</button>
        </div>

        <div id="feedbackSection" class="feedback-section hidden">
            <p id="feedbackText" class="text-lg"></p>
            <p id="remediationLink" class="mt-2 font-semibold"></p>
        </div>

        <div id="printableReport">
            </div>
    </div>

    <script>
        let studentPath = []; 
        const mainProblemCorrectAnswer = "0"; // x = 0

        // Helper to queue MathJax typesetting
        function queueMathJaxTypeset(element) {
            if (window.MathJax && window.MathJax.typesetPromise) {
                // console.log("Queueing MathJax typeset for element:", element ? (element.id || element.tagName) : "all"); 
                window.MathJax.typesetPromise(element ? [element] : undefined).catch((err) => console.error('MathJax typesetting error:', err));
            } else {
                // console.warn("MathJax or typesetPromise not available for typesetting."); 
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Content Loaded. Initial MathJax typeset queued for mainProblemSection.");
            queueMathJaxTypeset(document.getElementById('mainProblemSection'));
        });

        // Function to show/hide sections
        function showSection(sectionId) {
            const allSectionIds = [
                'mainProblemSection', 
                'diagnosticQ1Section', 'diagnosticQ1_sub_multiplyConstant', 'diagnosticQ1_sub_signRule', 'diagnosticQ1_sub_signRule_apply', 'diagnosticQ1_sub_multiplyVariable',
                'diagnosticQ2Section', /* Placeholder for Q2 sub-sections */
                'diagnosticQ3Section', /* Placeholder for Q3 sub-sections */
                'diagnosticQ4Section'  /* Placeholder for Q4 sub-sections */
            ];

            allSectionIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            
            if (sectionId) {
                const el = document.getElementById(sectionId);
                if (el) {
                    el.classList.remove('hidden');
                    queueMathJaxTypeset(el); // Typeset the newly shown section
                } else {
                    console.error("Attempted to show non-existent section:", sectionId);
                }
            }
        }

        // Function to display feedback
        function displayFeedback(message, remediation) {
            const feedbackTextEl = document.getElementById('feedbackText');
            const remediationLinkEl = document.getElementById('remediationLink');
            
            feedbackTextEl.innerHTML = message; 
            remediationLinkEl.innerHTML = remediation ? `<strong>מוקד מומלץ לחיזוק:</strong> ${remediation}` : '';
            
            const feedbackSectionEl = document.getElementById('feedbackSection');
            feedbackSectionEl.classList.remove('hidden');
            queueMathJaxTypeset(feedbackSectionEl); 

            // Log this feedback to studentPath
            const plainMessage = (feedbackTextEl.textContent || feedbackTextEl.innerText || "").trim();
            studentPath.push({ type: 'feedback', message: plainMessage, remediationTopic: remediation || null });
            // console.log("נתיב האבחון של התלמיד:", studentPath); 
        }
        
        // Function to start over
        function startOver() {
            console.log("מתחיל מחדש...");
            studentPath = []; 
            
            const radioGroups = [
                'mainAnswer', 
                'diagQ1Answer', 'diagQ1_sub_mc_Answer', 'diagQ1_sub_sr_Answer', 'diagQ1_sub_sra_Answer', 'diagQ1_sub_mv_Answer',
                'diagQ2Answer', /* Q2 sub-answers */
                'diagQ3Answer', /* Q3 sub-answers */
                'diagQ4Answer'  /* Q4 sub-answers */
            ];
            radioGroups.forEach(groupName => {
                const radios = document.getElementsByName(groupName);
                radios.forEach(radio => radio.checked = false);
            });
            
            document.getElementById('feedbackSection').classList.add('hidden');
            showSection('mainProblemSection'); 
            console.log("המבחן אופס למצב התחלתי.");
        }

        // Function to get selected radio value
        function getSelectedRadioValue(name) {
            const radios = document.getElementsByName(name);
            for (let i = 0; i < radios.length; i++) {
                if (radios[i].checked) {
                    return radios[i].value;
                }
            }
            return null;
        }

        // Function to get question text for report (tries to get text content)
        function getQuestionTextForReport(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                const problemStatementEl = section.querySelector('.problem-statement');
                const questionTextEl = section.querySelector('.question-text');
                let fullQuestionText = "";

                if (problemStatementEl) {
                    fullQuestionText += (problemStatementEl.textContent || problemStatementEl.innerText || "").trim();
                }
                if (questionTextEl) {
                    // Add space if problem statement also exists
                    fullQuestionText += (fullQuestionText ? " " : "") + (questionTextEl.textContent || questionTextEl.innerText || "").trim();
                }
                // Replace multiple spaces/newlines with a single space for cleaner report
                return fullQuestionText.replace(/\s\s+/g, ' ').trim() || "טקסט שאלה לא נמצא";
            }
            return "טקסט שאלה לא נמצא";
        }
        
        // Function to share/print report
        function shareReport() {
            console.log("מכין דוח לשיתוף/הדפסה...");
            const reportContainer = document.getElementById('printableReport');
            if (!reportContainer) {
                console.error("מיכל הדוח להדפסה לא נמצא.");
                return;
            }

            let reportHTML = '<h2>דוח אבחון אינטראקטיבי במתמטיקה</h2>';
            const remediationTopics = new Set();

            if (studentPath.length === 0) {
                reportHTML += '<p>לא נרשמה התקדמות עדיין.</p>';
            } else {
                studentPath.forEach((item, index) => {
                    reportHTML += `<div class="report-item">`;
                    if (item.type === 'attempt') {
                        reportHTML += `<p><strong>${item.stepDescription || 'ניסיון'}:</strong> ${item.questionText}</p>`;
                        // For MathJax, the selected answer might contain LaTeX.
                        // It's tricky to display this perfectly in a simple HTML report without re-running MathJax.
                        // For simplicity, we'll display the value, which might be the LaTeX string.
                        let answerDisplay = item.selectedAnswerText || item.selectedAnswer || 'לא צוינה';
                        // Basic attempt to clean up MathJax for display if it's a simple value
                        answerDisplay = answerDisplay.replace(/\$/g, ''); 
                        reportHTML += `<p><strong>תשובה שנבחרה:</strong> ${answerDisplay}</p>`;
                    } else if (item.type === 'feedback') {
                        reportHTML += `<p><strong>משוב והכוונה:</strong> ${item.message}</p>`;
                        if (item.remediationTopic) {
                            remediationTopics.add(item.remediationTopic);
                        }
                    }
                    reportHTML += `</div>`;
                });
            }

            if (remediationTopics.size > 0) {
                reportHTML += '<h3>מוקדים מומלצים לחיזוק:</h3><ul>';
                remediationTopics.forEach(topic => {
                    reportHTML += `<li>${topic}</li>`;
                });
                reportHTML += '</ul>';
            } else if (studentPath.length > 0) {
                const lastEvent = studentPath[studentPath.length - 1];
                let mainProblemSolvedCorrectly = false;
                // Check if the last feedback indicates overall success
                if (lastEvent && lastEvent.type === 'feedback' && 
                    (lastEvent.message.includes("מעולה! תשובתך הסופית נכונה") || lastEvent.message.includes("מעולה! הוספת 1 לשני אגפי המשוואה"))) {
                    mainProblemSolvedCorrectly = true;
                }
                
                // Check if the first attempt on main problem was correct
                const firstMainAttempt = studentPath.find(item => item.type === 'attempt' && item.stepDescription === "בעיה ראשית");
                if (firstMainAttempt && firstMainAttempt.selectedAnswer === mainProblemCorrectAnswer) {
                     mainProblemSolvedCorrectly = true;
                }


                if (mainProblemSolvedCorrectly && remediationTopics.size === 0) {
                     reportHTML += '<p>כל הכבוד! לא זוהו מוקדים ספציפיים לחיזוק על סמך המשוב שניתן.</p>';
                } else if (remediationTopics.size === 0) {
                     reportHTML += '<p>לא זוהו מוקדים ספציפיים לחיזוק על סמך המשוב שניתן במהלך סשן זה.</p>';
                }
            }
            reportContainer.innerHTML = reportHTML;
            // MathJax might need to process the report if it contains LaTeX.
            // However, for printing, it's often better to have plain text or SVGs already.
            // If complex LaTeX is in the report, this might not render perfectly without extra steps.
            // queueMathJaxTypeset(reportContainer); // Optional: try to render MathJax in report before printing
            window.print(); 
        }

        // --- Check Answer Functions ---

        function checkMainAnswer() {
            const answer = getSelectedRadioValue('mainAnswer');
            if (!answer) {
                displayFeedback("אנא בחר תשובה.", null);
                return;
            }
            const questionReportText = getQuestionTextForReport('mainProblemSection');
            const selectedOption = document.querySelector('input[name="mainAnswer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;

            studentPath.push({ type: 'attempt', stepDescription: "בעיה ראשית", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === mainProblemCorrectAnswer) {
                displayFeedback("מעולה! תשובתך הסופית נכונה: $x = 0$.", null);
                showSection(null); 
            } else {
                displayFeedback("זה לא בדיוק נכון. בוא ננסה למצוא היכן הטעות עשויה להיות.", "שלבים כלליים לפתרון משוואה לינארית");
                showSection('diagnosticQ1Section');
            }
        }

        function checkDiagnosticQ1() {
            const answer = getSelectedRadioValue('diagQ1Answer');
            if (!answer) {
                displayFeedback("אנא בחר תשובה לשלב 1.", null);
                return;
            }
            const questionReportText = getQuestionTextForReport('diagnosticQ1Section');
            const selectedOption = document.querySelector('input[name="diagQ1Answer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentPath.push({ type: 'attempt', stepDescription: "שלב 1: פתיחת סוגריים", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            document.getElementById('feedbackSection').classList.add('hidden'); // Hide previous feedback

            if (answer === "3x-6") { 
                displayFeedback("נכון מאוד! $3(x-2)$ אכן שווה ל-$3x-6$. ממשיכים לשלב הבא.", null);
                setTimeout(() => {
                    showSection('diagnosticQ2Section');
                    document.getElementById('feedbackSection').classList.add('hidden');
                }, 2000);
            } else if (answer === "3x-2") { 
                // Don't display immediate feedback here, go to sub-question
                showSection('diagnosticQ1_sub_multiplyConstant');
            } else if (answer === "3x+6") { 
                showSection('diagnosticQ1_sub_signRule');
            } else if (answer === "x-6") { 
                showSection('diagnosticQ1_sub_multiplyVariable');
            }
        }

        // Sub-diagnostic check functions for Q1
        function checkDiagnosticQ1_sub_multiplyConstant() {
            const answer = getSelectedRadioValue('diagQ1_sub_mc_Answer');
            if (!answer) { displayFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReport('diagnosticQ1_sub_multiplyConstant');
            const selectedOption = document.querySelector('input[name="diagQ1_sub_mc_Answer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentPath.push({ type: 'attempt', stepDescription: "שלב 1.1: פילוג - כפל קבוע $3 \\times (-2)$", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === "-6") {
                displayFeedback("נכון! $3 \\times (-2) = -6$. לכן, הביטוי המלא $3(x-2)$ הוא $3x - 6$. ממשיכים לשלב הבא של הבעיה המקורית.", null);
                setTimeout(() => {
                    showSection('diagnosticQ2Section');
                    document.getElementById('feedbackSection').classList.add('hidden');
                }, 3000);
            } else {
                let remediationMsg = "זה עדיין לא מדויק. התוצאה של $3 \\times (-2)$ היא $-6$. <br>כאשר מכפילים מספר חיובי במספר שלילי, התוצאה היא שלילית. $3 \\times 2 = 6$, לכן $3 \\times (-2) = -6$.";
                if (answer === "1") remediationMsg += "<br>שים לב, הפעולה היא כפל, לא חיסור ($3-2=1$).";
                displayFeedback(remediationMsg, "כפל מספרים מכוונים (חיובי בשלילי)");
                showSection(null); 
            }
        }

        function checkDiagnosticQ1_sub_signRule() {
            const answer = getSelectedRadioValue('diagQ1_sub_sr_Answer');
            if (!answer) { displayFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReport('diagnosticQ1_sub_signRule');
            const selectedOption = document.querySelector('input[name="diagQ1_sub_sr_Answer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentPath.push({ type: 'attempt', stepDescription: "שלב 1.2: פילוג - כלל סימנים ל $3 \\times (-2)$", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });
            
            if (answer === "negative") {
                 // Ask them to apply it
                document.getElementById('feedbackSection').classList.add('hidden');
                showSection('diagnosticQ1_sub_signRule_apply');
            } else { // Answer was "positive"
                displayFeedback("לא בדיוק. הכלל הוא: חיובי $\\times$ שלילי = שלילי. לכן $3 \\times (-2)$ צריך להיות עם סימן שלילי. <br>התוצאה היא $-6$. מכאן $3(x-2) = 3x-6$.", "כללי סימנים בכפל");
                // Option to proceed or stop. For now, let's try to proceed if they acknowledge the rule.
                // To make it simpler, we'll stop here and recommend review.
                showSection(null); 
            }
        }
        
        function checkDiagnosticQ1_sub_signRule_apply() {
            const answer = getSelectedRadioValue('diagQ1_sub_sra_Answer');
            if (!answer) { displayFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReport('diagnosticQ1_sub_signRule_apply');
            const selectedOption = document.querySelector('input[name="diagQ1_sub_sra_Answer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentPath.push({ type: 'attempt', stepDescription: "שלב 1.2א: פילוג - יישום $3 \\times (-2)$", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === "-6") {
                displayFeedback("מעולה! זיהית נכון את כלל הסימנים והתוצאה היא $3 \\times (-2) = -6$. <br>לכן, הביטוי המלא $3(x-2)$ הוא $3x - 6$. ממשיכים לשלב הבא של הבעיה המקורית.", null);
                setTimeout(() => {
                    showSection('diagnosticQ2Section');
                    document.getElementById('feedbackSection').classList.add('hidden');
                }, 3500);
            } else {
                 displayFeedback("זה עדיין לא מדויק. אם התוצאה של חיובי כפול שלילי היא שלילית, אז $3 \\times (-2)$ הוא $-6$. <br>נראה שעדיין יש קושי ביישום כללי הסימנים בכפל.", "יישום כללי סימנים בכפל");
                showSection(null);
            }
        }


        function checkDiagnosticQ1_sub_multiplyVariable() {
            const answer = getSelectedRadioValue('diagQ1_sub_mv_Answer');
            if (!answer) { displayFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReport('diagnosticQ1_sub_multiplyVariable');
            const selectedOption = document.querySelector('input[name="diagQ1_sub_mv_Answer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentPath.push({ type: 'attempt', stepDescription: "שלב 1.3: פילוג - כפל משתנה $3 \\times x$", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === "3x") {
                displayFeedback("נכון! $3 \\times x = 3x$. לכן, הביטוי המלא $3(x-2)$ הוא $3x - 6$. ממשיכים לשלב הבא של הבעיה המקורית.", null);
                setTimeout(() => {
                    showSection('diagnosticQ2Section');
                    document.getElementById('feedbackSection').classList.add('hidden');
                }, 3000);
            } else {
                displayFeedback("זה עדיין לא מדויק. $3 \\times x$ הוא פשוט $3x$. <br> נראה שיש קושי בהבנת הכפל של מספר במשתנה.", "כפל מספר במשתנה");
                showSection(null); 
            }
        }

        // --- Placeholder for Q2, Q3, Q4 check functions and their sub-diagnostics ---
        function checkDiagnosticQ2() {
            const answer = getSelectedRadioValue('diagQ2Answer');
            if (!answer) { displayFeedback("אנא בחר תשובה לשלב 2.", null); return; }
            const questionReportText = getQuestionTextForReport('diagnosticQ2Section');
            const selectedOption = document.querySelector('input[name="diagQ2Answer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentPath.push({ type: 'attempt', stepDescription: "שלב 2: כינוס איברים", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });
            document.getElementById('feedbackSection').classList.add('hidden'); 

            if (answer === "3x-1") { 
                displayFeedback("מצוין! $3x-6+5$ אכן מתכנס ל-$3x-1$. ממשיכים!", null);
                 setTimeout(() => {
                    showSection('diagnosticQ3Section');
                    document.getElementById('feedbackSection').classList.add('hidden');
                }, 2000);
            } else if (answer === "3x+11") { 
                displayFeedback("נראה שיש טעות קטנה בחיבור המספרים. זכור, $-6 + 5$ שווה ל-$-1$, לא $+11$. לכן, $3x - 6 + 5$ מתכנס ל-$3x - 1$.", "חיבור/חיסור מספרים מכוונים");
                showSection(null); // Or sub-diagnostic: "What is -6 + 5?"
            } else if (answer === "2x") { 
                displayFeedback("שים לב! ניתן לחבר רק 'איברים דומים'. כלומר, מחברים מספרים עם מספרים, ואיברים עם $x$ עם איברים אחרים עם $x$. לא ניתן לחבר ישירות $3x$ ו-$-1$. לכן, $3x - 6 + 5$ מתכנס ל-$3x - 1$.", "זיהוי וכינוס איברים דומים");
                showSection(null); // Or sub-diagnostic: "Which terms in 3x-6+5 are 'like terms'?"
            } else if (answer === "3x+1") { 
                displayFeedback("כמעט! בדוק את הסימנים בעת חיבור $-6$ ו-$+5$. התוצאה היא $-1$, לא $+1$. לכן, $3x - 6 + 5$ מתכנס ל-$3x - 1$.", "חיבור/חיסור מספרים מכוונים (סימנים)");
                showSection(null); // Or sub-diagnostic: "What is -6 + 5?"
            }
        }

        function checkDiagnosticQ3() {
            const answer = getSelectedRadioValue('diagQ3Answer');
            if (!answer) { displayFeedback("אנא בחר תשובה לשלב 3.", null); return; }
            const questionReportText = getQuestionTextForReport('diagnosticQ3Section');
            const selectedOption = document.querySelector('input[name="diagQ3Answer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentPath.push({ type: 'attempt', stepDescription: "שלב 3: העברת אגפים - משתנים", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });
            document.getElementById('feedbackSection').classList.add('hidden');
            
            if (answer === "x-1 = -1") { 
                displayFeedback("נכון מאוד! לאחר חיסור $2x$ משני האגפים, מקבלים $x-1 = -1$.", null);
                setTimeout(() => {
                    showSection('diagnosticQ4Section');
                    document.getElementById('feedbackSection').classList.add('hidden');
                }, 2000);
            } else if (answer === "5x-1 = -1") { 
                 displayFeedback("נראה שאולי חיברת $2x$ ל-$3x$ במקום לחסר, או שקרתה טעות בסימנים. זכור, $3x - 2x = x$. לכן, $3x-1 = 2x-1$ הופך ל-$x-1 = -1$.", "חיסור איברים עם משתנים");
                showSection(null); // Sub-diagnostic: "What is 3x - 2x?"
            } else if (answer === "x-1 = 2x-1-2x") { 
                 displayFeedback("חיסרת נכון $2x$ מ-$3x-1$ וקיבלת $x-1$. כעת, למה שווה הביטוי $2x-1-2x$ באגף ימין? הוא שווה ל-$-1$. לכן המשוואה היא $x-1 = -1$.", "פישוט שני אגפי המשוואה");
                showSection(null); // Sub-diagnostic: "What is 2x - 1 - 2x simplified?"
            }
        }

        function checkDiagnosticQ4() {
            const answer = getSelectedRadioValue('diagQ4Answer');
            if (!answer) { displayFeedback("אנא בחר תשובה לשלב 4.", null); return; }
            const questionReportText = getQuestionTextForReport('diagnosticQ4Section');
            const selectedOption = document.querySelector('input[name="diagQ4Answer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentPath.push({ type: 'attempt', stepDescription: "שלב 4: בידוד המשתנה", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === "x = 0") { 
                displayFeedback("מעולה! הוספת 1 לשני אגפי המשוואה $x-1 = -1$ נותנת $x = 0$. זה אומר שאם כל השלבים הקודמים היו נכונים, זהו הפתרון. אם תשובתך הראשית הייתה שונה, בדוק שוב במחברת היכן החישוב הסתעף!", null);
                showSection(null);
            } else if (answer === "x = -2") { 
                displayFeedback("שים לב לחשבון או לפעולה. כאשר יש לנו $x-1 = -1$ ואנו מוסיפים 1 לשני האגפים: $x - 1 + 1 = -1 + 1$. זה מתכנס ל-$x = 0$.", "פתרון משוואות צעד אחד (חיבור/חיסור)");
                showSection(null); // Sub-diagnostic: "What is -1 + 1?"
            } else if (answer === "x = 1") { 
                displayFeedback("כמעט! זכור ש-$-1 + 1 = 0$. לכן, אם $x-1 = -1$, הוספת 1 לשני האגפים נותנת $x=0$.", "חיבור מספרים מכוונים (זוגות אפס)");
                showSection(null); // Sub-diagnostic: "What is -1 + 1?"
            }
        }

    </script>
</body>
</html>
