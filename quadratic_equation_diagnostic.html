<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מבחן אבחון: משוואה ממעלה שנייה</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f1f5f9; /* slate-100 */
            color: #1e293b; /* slate-800 */
        }
        .container-quiz {
            max-width: 700px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #ffffff;
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .question-section {
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            border: 1px solid #e2e8f0; /* slate-200 */
            border-radius: 0.5rem;
            background-color: #f8fafc; /* slate-50 */
        }
        .problem-statement {
            font-size: 1.25rem; /* text-xl */
            font-weight: 600;
            color: #0f172a; /* slate-900 */
            margin-bottom: 1rem;
        }
        .question-text, .equation-display {
            font-size: 1.1rem; /* Equivalent to text-lg approx */
            color: #334155; /* slate-700 */
            margin-bottom: 0.75rem;
        }
        .equation-display p { margin-bottom: 0.25rem; text-align: center; font-weight: 500;}
        label.option-label {
            display: block;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background-color: #fff;
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.375rem; /* rounded-md */
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
        }
        label.option-label:hover {
            background-color: #f1f5f9; /* slate-100 */
            border-color: #94a3b8; /* slate-400 */
        }
        input[type="radio"] {
            margin-left: 0.5rem; /* For RTL */
            accent-color: #2563eb; /* blue-600 */
        }
        button.submit-button {
            padding: 0.75rem 1.5rem;
            background-color: #2563eb; /* blue-600 */
            color: white;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* medium */
            cursor: pointer;
            transition: background-color 0.2s;
            margin-top: 1rem;
        }
        button.submit-button:hover {
            background-color: #1d4ed8; /* blue-700 */
        }
        button.action-button {
            padding: 0.5rem 1rem;
            background-color: #475569; /* slate-600 */
            color: white;
            border: none;
            border-radius: 0.375rem; /* rounded-md */
            font-weight: 500; /* medium */
            cursor: pointer;
            transition: background-color 0.2s;
            margin-right: 0.5rem; /* Space between buttons for RTL */
        }
        button.action-button:hover {
            background-color: #334155; /* slate-700 */
        }
        .feedback-section {
            margin-top: 1.5rem;
            padding: 1.5rem;
            border-radius: 0.5rem;
            background-color: #eff6ff; /* blue-50 */
            color: #1e40af; /* blue-800 */
            border: 1px solid #bfdbfe; /* blue-200 */
        }
        .hidden {
            display: none;
        }
        
        #printableReport {
            display: none; 
            padding: 20px;
            font-family: 'Assistant', sans-serif;
            color: #000; 
            direction: rtl; 
        }
        #printableReport h2, #printableReport h3 {
            font-weight: 600; margin-bottom: 1rem; border-bottom: 1px solid #ccc; padding-bottom: 0.5rem;
        }
        #printableReport h2 { font-size: 1.5rem; }
        #printableReport h3 { font-size: 1.3rem; margin-top: 1.5rem;}
        #printableReport .report-item { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px dotted #eee; }
        #printableReport .report-item:last-child { border-bottom: none; }
        #printableReport p { margin-bottom: 0.25rem; }
        #printableReport strong { font-weight: 600; }
        #printableReport ul { list-style-type: disc; margin-right: 20px; padding-right: 20px; }
        #printableReport li { margin-bottom: 0.25rem; }

        @media print {
            body * { visibility: hidden; }
            #printableReport, #printableReport * { visibility: visible; }
            #printableReport { position: absolute; left: 0; top: 0; width: 100%; display: block !important; font-size: 12pt; }
            .container-quiz > h1, .container-quiz > div:first-of-type, .question-section, .feedback-section { display: none !important; visibility: hidden !important; }
        }
    </style>
    <script>
        window.MathJax = {
          tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']],
            displayMath: [['$$', '$$'], ['\\[', '\\]']]
          },
          svg: {
            fontCache: 'global'
          }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
    </script>
</head>
<body class="bg-slate-100 text-slate-800">

    <div class="container-quiz">
        <h1 class="text-2xl font-bold text-center text-slate-700 mb-6">מבחן אבחון: משוואה ממעלה שנייה</h1>

        <div class="mb-6 text-center">
            <button class="action-button" onclick="startOverQuadratic()">התחל מחדש</button>
            <button class="action-button" onclick="shareReportQuadratic()">שתף דוח</button>
        </div>

        <div id="mainQuadraticProblemSection" class="question-section">
            <p class="problem-statement">בעיה ראשית:</p>
            <p class="question-text">פתור את המשוואה הריבועית הבאה עבור $x$:</p>
            <div class="equation-display">
                <p>$x^2 - 5x + 6 = 0$</p>
            </div>
            <p class="text-sm text-slate-500 mb-3">אנא פתור זאת במחברתך תחילה (מומלץ להשתמש בנוסחת השורשים), ולאחר מכן בחר את תשובתך הסופית למטה.</p>
            
            <div id="mainQuadraticProblemOptions">
                <label class="option-label"><input type="radio" name="mainQuadraticAnswer" value="x=2,x=3"> א) $x=2, x=3$</label>
                <label class="option-label"><input type="radio" name="mainQuadraticAnswer" value="x=-2,x=-3"> ב) $x=-2, x=-3$</label>
                <label class="option-label"><input type="radio" name="mainQuadraticAnswer" value="x=1,x=6"> ג) $x=1, x=6$</label>
                <label class="option-label"><input type="radio" name="mainQuadraticAnswer" value="no_solution"> ד) אין פתרון ממשי</label>
            </div>
            <button class="submit-button" onclick="checkMainQuadraticAnswer()">הגש תשובה</button>
        </div>

        <div id="diagnosticQuadQ1_coeffsSection" class="question-section hidden">
            <p class="problem-statement">שלב 1: זיהוי מקדמים</p>
            <p class="question-text">במשוואה $x^2 - 5x + 6 = 0$, מהם ערכי המקדמים $a, b, c$?</p>
            <div id="diagnosticQuadQ1_coeffsOptions">
                <label class="option-label"><input type="radio" name="diagQuadQ1_coeffsAnswer" value="a=1,b=-5,c=6"> א) $a=1, b=-5, c=6$</label>
                <label class="option-label"><input type="radio" name="diagQuadQ1_coeffsAnswer" value="a=1,b=5,c=6"> ב) $a=1, b=5, c=6$ (טעות בסימן של $b$)</label>
                <label class="option-label"><input type="radio" name="diagQuadQ1_coeffsAnswer" value="a=0,b=-5,c=6"> ג) $a=0, b=-5, c=6$ (טעות בזיהוי $a$)</label>
                <label class="option-label"><input type="radio" name="diagQuadQ1_coeffsAnswer" value="a=1,b=-5,c=-6"> ד) $a=1, b=-5, c=-6$ (טעות בסימן של $c$)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQuadQ1_coeffs()">הגש תשובה לשלב 1</button>
        </div>
        
        <div id="diagnosticQuadQ2_discriminantSection" class="question-section hidden">
            <p class="problem-statement">שלב 2: חישוב הדיסקרימיננטה</p>
            <p class="question-text">הדיסקרימיננטה נתונה על ידי $\Delta = b^2 - 4ac$.<br>בהנחה ש-$a=1, b=-5, c=6$, מהו ערך הדיסקרימיננטה $\Delta$?</p>
            <div id="diagnosticQuadQ2_discriminantOptions">
                <label class="option-label"><input type="radio" name="diagQuadQ2_discAnswer" value="1"> א) $\Delta = 1$</label>
                <label class="option-label"><input type="radio" name="diagQuadQ2_discAnswer" value="49"> ב) $\Delta = 49$ (אולי טעות בחישוב $b^2$ או $4ac$)</label>
                <label class="option-label"><input type="radio" name="diagQuadQ2_discAnswer" value="-23"> ג) $\Delta = -23$ (אולי טעות בסימן של $4ac$ או בחיסור)</label>
                 <label class="option-label"><input type="radio" name="diagQuadQ2_discAnswer" value="25"> ד) $\Delta = 25$ (אולי שכחת את החלק של $-4ac$)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQuadQ2_discriminant()">הגש תשובה לשלב 2</button>
        </div>

        <div id="diagnosticQuadQ2_sub_bSquared" class="question-section hidden">
            <p class="problem-statement">פירוק שלב 2: חישוב $b^2$</p>
            <p class="question-text">אם $b=-5$, למה שווה $b^2$? כלומר, $(-5)^2$?</p>
            <div id="diagnosticQuadQ2_sub_bSquaredOptions">
                <label class="option-label"><input type="radio" name="diagQuadQ2_sub_bSqAnswer" value="25"> א) $25$</label>
                <label class="option-label"><input type="radio" name="diagQuadQ2_sub_bSqAnswer" value="-25"> ב) $-25$</label>
                <label class="option-label"><input type="radio" name="diagQuadQ2_sub_bSqAnswer" value="-10"> ג) $-10$</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQuadQ2_sub_bSquared()">הגש תשובה</button>
        </div>
        
        <div id="diagnosticQuadQ2_sub_4ac" class="question-section hidden">
            <p class="problem-statement">פירוק שלב 2: חישוב $4ac$</p>
            <p class="question-text">אם $a=1$ ו-$c=6$, למה שווה $4ac$?</p>
            <div id="diagnosticQuadQ2_sub_4acOptions">
                <label class="option-label"><input type="radio" name="diagQuadQ2_sub_4acAnswer" value="24"> א) $24$</label>
                <label class="option-label"><input type="radio" name="diagQuadQ2_sub_4acAnswer" value="10"> ב) $10$</label>
                <label class="option-label"><input type="radio" name="diagQuadQ2_sub_4acAnswer" value="-24"> ג) $-24$ (שים לב, אנו מחשבים $4ac$ ולא $-4ac$ בשלב זה)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQuadQ2_sub_4ac()">הגש תשובה</button>
        </div>

        <div id="diagnosticQuadQ3_formulaSection" class="question-section hidden">
            <p class="problem-statement">שלב 3: שימוש בנוסחת השורשים</p>
            <p class="question-text">נוסחת השורשים היא $x_{1,2} = \frac{-b \pm \sqrt{\Delta}}{2a}$.<br>בהנחה ש-$a=1, b=-5, \Delta=1$, הצב את הערכים בנוסחה. איזה ביטוי מתקבל?</p>
            <div id="diagnosticQuadQ3_formulaOptions">
                <label class="option-label"><input type="radio" name="diagQuadQ3_formAnswer" value="(5pm1)/2"> א) $x = \frac{5 \pm \sqrt{1}}{2}$</label>
                <label class="option-label"><input type="radio" name="diagQuadQ3_formAnswer" value="(-5pm1)/2"> ב) $x = \frac{-5 \pm \sqrt{1}}{2}$ (טעות בסימן של $-b$)</label>
                <label class="option-label"><input type="radio" name="diagQuadQ3_formAnswer" value="(5pm_sqrt_delta_error)/2"> ג) $x = \frac{5 \pm 1}{2}$ (הצבת $\Delta$ במקום $\sqrt{\Delta}$ בטעות, או $\sqrt{1}$ נכון)</label>
                <label class="option-label"><input type="radio" name="diagQuadQ3_formAnswer" value="(5pm1)/1"> ד) $x = \frac{5 \pm \sqrt{1}}{1}$ (טעות בחישוב $2a$)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQuadQ3_formula()">הגש תשובה לשלב 3</button>
        </div>

        <div id="diagnosticQuadQ4_rootsSection" class="question-section hidden">
            <p class="problem-statement">שלב 4: חישוב השורשים</p>
            <p class="question-text">אם הגענו לביטוי $x = \frac{5 \pm 1}{2}$, מהם שני הפתרונות $x_1, x_2$?</p>
            <div id="diagnosticQuadQ4_rootsOptions">
                <label class="option-label"><input type="radio" name="diagQuadQ4_rootsAnswer" value="x1=3,x2=2"> א) $x_1 = 3, x_2 = 2$ (או להיפך)</label>
                <label class="option-label"><input type="radio" name="diagQuadQ4_rootsAnswer" value="x1=6,x2=4"> ב) $x_1 = 6, x_2 = 4$ (שכחת לחלק ב-2)</label>
                <label class="option-label"><input type="radio" name="diagQuadQ4_rootsAnswer" value="x1=2.5,x2=1.5"> ג) $x_1 = 2.5, x_2 = 1.5$ (טעות בחישוב עם הפלוס/מינוס)</label>
            </div>
            <button class="submit-button" onclick="checkDiagnosticQuadQ4_roots()">הגש תשובה לשלב 4</button>
        </div>

        <div id="feedbackQuadraticSection" class="feedback-section hidden">
            <p id="feedbackQuadraticText" class="text-lg"></p>
            <p id="remediationQuadraticLink" class="mt-2 font-semibold"></p>
        </div>

        <div id="printableReport">
        </div>
    </div>

    <script>
        let studentQuadraticPath = []; 
        const mainQuadraticProblemCorrectAnswer = "x=2,x=3"; 
        // Store correct intermediate values to guide sub-diagnostics if needed
        const correctCoeffs = { a: 1, b: -5, c: 6 };
        const correctDiscriminant = 1;
        const correctFormulaExpression = "(5pm1)/2"; // Represents (5 +/- sqrt(1)) / 2

        function queueMathJaxTypeset(element) {
            if (window.MathJax && window.MathJax.typesetPromise) {
                window.MathJax.typesetPromise(element ? [element] : undefined).catch((err) => console.error('MathJax typesetting error:', err));
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            queueMathJaxTypeset(document.getElementById('mainQuadraticProblemSection'));
        });

        function showQuadraticSection(sectionId) {
            const allSectionIds = [
                'mainQuadraticProblemSection', 
                'diagnosticQuadQ1_coeffsSection',
                'diagnosticQuadQ2_discriminantSection', 'diagnosticQuadQ2_sub_bSquared', 'diagnosticQuadQ2_sub_4ac',
                'diagnosticQuadQ3_formulaSection',
                'diagnosticQuadQ4_rootsSection'
            ];

            allSectionIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            
            if (sectionId) {
                const el = document.getElementById(sectionId);
                if (el) {
                    el.classList.remove('hidden');
                    queueMathJaxTypeset(el);
                } else {
                    console.error("Attempted to show non-existent section:", sectionId);
                }
            }
        }

        function displayQuadraticFeedback(message, remediation) {
            const feedbackTextEl = document.getElementById('feedbackQuadraticText');
            const remediationLinkEl = document.getElementById('remediationQuadraticLink');
            
            feedbackTextEl.innerHTML = message; 
            remediationLinkEl.innerHTML = remediation ? `<strong>מוקד מומלץ לחיזוק:</strong> ${remediation}` : '';
            
            const feedbackSectionEl = document.getElementById('feedbackQuadraticSection');
            feedbackSectionEl.classList.remove('hidden');
            queueMathJaxTypeset(feedbackSectionEl); 

            const plainMessage = (feedbackTextEl.textContent || feedbackTextEl.innerText || "").trim();
            studentQuadraticPath.push({ type: 'feedback', message: plainMessage, remediationTopic: remediation || null });
        }
        
        function startOverQuadratic() {
            studentQuadraticPath = []; 
            const radioGroups = [
                'mainQuadraticAnswer', 
                'diagQuadQ1_coeffsAnswer',
                'diagQuadQ2_discAnswer', 'diagQuadQ2_sub_bSqAnswer', 'diagQuadQ2_sub_4acAnswer',
                'diagQuadQ3_formAnswer',
                'diagQuadQ4_rootsAnswer'
            ];
            radioGroups.forEach(groupName => {
                const radios = document.getElementsByName(groupName);
                radios.forEach(radio => radio.checked = false);
            });
            
            document.getElementById('feedbackQuadraticSection').classList.add('hidden');
            showQuadraticSection('mainQuadraticProblemSection'); 
        }

        function getSelectedRadioValueQuadratic(name) {
            const radios = document.getElementsByName(name);
            for (let i = 0; i < radios.length; i++) {
                if (radios[i].checked) {
                    return radios[i].value;
                }
            }
            return null;
        }

        function getQuestionTextForReportQuadratic(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                const problemStatementEl = section.querySelector('.problem-statement');
                const questionTextEl = section.querySelector('.question-text');
                const equationEl = section.querySelector('.equation-display');
                let fullQuestionText = "";

                if (problemStatementEl) {
                    fullQuestionText += (problemStatementEl.textContent || problemStatementEl.innerText || "").trim();
                }
                 if (equationEl) {
                     fullQuestionText += (fullQuestionText ? " " : "") + (equationEl.innerText || equationEl.textContent || "").replace(/\s\s+/g, ' ').trim();
                }
                if (questionTextEl) {
                    fullQuestionText += (fullQuestionText ? " " : "") + (questionTextEl.textContent || questionTextEl.innerText || "").trim();
                }
                return fullQuestionText.replace(/\s\s+/g, ' ').trim() || "טקסט שאלה לא נמצא";
            }
            return "טקסט שאלה לא נמצא";
        }
        
        function shareReportQuadratic() {
            const reportContainer = document.getElementById('printableReport');
            if (!reportContainer) { return; }

            let reportHTML = '<h2>דוח אבחון: משוואה ממעלה שנייה</h2>';
            const remediationTopics = new Set();

            if (studentQuadraticPath.length === 0) {
                reportHTML += '<p>לא נרשמה התקדמות עדיין.</p>';
            } else {
                studentQuadraticPath.forEach((item) => {
                    reportHTML += `<div class="report-item">`;
                    if (item.type === 'attempt') {
                        reportHTML += `<p><strong>${item.stepDescription || 'ניסיון'}:</strong> ${item.questionText}</p>`;
                        let answerDisplay = item.selectedAnswerText || item.selectedAnswer || 'לא צוינה';
                        answerDisplay = answerDisplay.replace(/\$/g, ''); 
                        reportHTML += `<p><strong>תשובה שנבחרה:</strong> ${answerDisplay}</p>`;
                    } else if (item.type === 'feedback') {
                        reportHTML += `<p><strong>משוב והכוונה:</strong> ${item.message}</p>`;
                        if (item.remediationTopic) {
                            remediationTopics.add(item.remediationTopic);
                        }
                    }
                    reportHTML += `</div>`;
                });
            }

            if (remediationTopics.size > 0) {
                reportHTML += '<h3>מוקדים מומלצים לחיזוק:</h3><ul>';
                remediationTopics.forEach(topic => { reportHTML += `<li>${topic}</li>`; });
                reportHTML += '</ul>';
            } else if (studentQuadraticPath.length > 0) {
                 const lastFeedback = studentQuadraticPath.filter(item => item.type === 'feedback').pop();
                 let mainProblemSolvedCorrectly = false;
                 if (lastFeedback && lastFeedback.message.includes("כל הכבוד! הפתרונות $x=2, x=3$ נכונים")) {
                    mainProblemSolvedCorrectly = true;
                 }

                if (mainProblemSolvedCorrectly && remediationTopics.size === 0) {
                     reportHTML += '<p>כל הכבוד! לא זוהו מוקדים ספציפיים לחיזוק על סמך המשוב שניתן.</p>';
                } else if (remediationTopics.size === 0) {
                     reportHTML += '<p>לא זוהו מוקדים ספציפיים לחיזוק על סמך המשוב שניתן במהלך סשן זה.</p>';
                }
            }
            reportContainer.innerHTML = reportHTML;
            window.print(); 
        }

        // --- Check Answer Functions ---

        function checkMainQuadraticAnswer() {
            const answer = getSelectedRadioValueQuadratic('mainQuadraticAnswer');
            if (!answer) {
                displayQuadraticFeedback("אנא בחר תשובה.", null);
                return;
            }
            const questionReportText = getQuestionTextForReportQuadratic('mainQuadraticProblemSection');
            const selectedOption = document.querySelector('input[name="mainQuadraticAnswer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;

            studentQuadraticPath.push({ type: 'attempt', stepDescription: "בעיה ראשית", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === mainQuadraticProblemCorrectAnswer) {
                displayQuadraticFeedback("מעולה! הפתרונות $x=2, x=3$ נכונים.", null);
                showQuadraticSection(null); 
            } else {
                displayQuadraticFeedback("התשובה אינה מדויקת. בוא נפרק את השלבים לפתרון באמצעות נוסחת השורשים.", "פתרון משוואה ריבועית");
                showQuadraticSection('diagnosticQuadQ1_coeffsSection');
            }
        }

        function checkDiagnosticQuadQ1_coeffs() {
            const answer = getSelectedRadioValueQuadratic('diagQuadQ1_coeffsAnswer');
            if (!answer) { displayQuadraticFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReportQuadratic('diagnosticQuadQ1_coeffsSection');
            const selectedOption = document.querySelector('input[name="diagQuadQ1_coeffsAnswer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentQuadraticPath.push({ type: 'attempt', stepDescription: "שלב 1: זיהוי מקדמים", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });
            
            document.getElementById('feedbackQuadraticSection').classList.add('hidden');

            if (answer === "a=1,b=-5,c=6") {
                displayQuadraticFeedback("נכון מאוד! המקדמים הם $a=1, b=-5, c=6$. ממשיכים לחישוב הדיסקרימיננטה.", null);
                setTimeout(() => { 
                    showQuadraticSection('diagnosticQuadQ2_discriminantSection');
                    document.getElementById('feedbackQuadraticSection').classList.add('hidden');
                }, 2500);
            } else if (answer === "a=1,b=5,c=6") {
                 displayQuadraticFeedback("שים לב לסימן של $b$. במשוואה $x^2 - 5x + 6 = 0$, המקדם של $x$ הוא $-5$.", "זיהוי סימן המקדם $b$");
                 showQuadraticSection(null);
            } else if (answer === "a=0,b=-5,c=6") {
                 displayQuadraticFeedback("המקדם $a$ הוא המקדם של $x^2$. אם $x^2$ מופיע ללא מספר לפניו, זה אומר שהמקדם שלו הוא $1$ (ולא $0$).", "זיהוי המקדם $a$");
                 showQuadraticSection(null);
            } else { // a=1,b=-5,c=-6
                 displayQuadraticFeedback("שים לב לסימן של $c$. במשוואה $x^2 - 5x + 6 = 0$, האיבר החופשי הוא $+6$.", "זיהוי סימן המקדם $c$");
                 showQuadraticSection(null);
            }
        }
        
        function checkDiagnosticQuadQ2_discriminant() {
            const answer = getSelectedRadioValueQuadratic('diagQuadQ2_discAnswer');
            if (!answer) { displayQuadraticFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReportQuadratic('diagnosticQuadQ2_discriminantSection');
            const selectedOption = document.querySelector('input[name="diagQuadQ2_discAnswer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentQuadraticPath.push({ type: 'attempt', stepDescription: "שלב 2: חישוב דיסקרימיננטה", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });
            document.getElementById('feedbackQuadraticSection').classList.add('hidden');

            if (answer === "1") {
                displayQuadraticFeedback("חישוב מדויק! $\Delta = (-5)^2 - 4(1)(6) = 25 - 24 = 1$. ממשיכים לנוסחת השורשים.", null);
                setTimeout(() => {
                    showQuadraticSection('diagnosticQuadQ3_formulaSection');
                    document.getElementById('feedbackQuadraticSection').classList.add('hidden');
                }, 3000);
            } else if (answer === "25") { // Forgot -4ac
                 displayQuadraticFeedback("נראה שחישבת נכון את $b^2 = (-5)^2 = 25$, אבל שכחת לחסר את $4ac$.", "השלמת חישוב דיסקרימיננטה");
                 showQuadraticSection('diagnosticQuadQ2_sub_4ac'); // Ask specifically about 4ac
            } else if (answer === "49") { // Error in b^2 or 4ac
                 displayQuadraticFeedback("התוצאה אינה $49$. בוא נבדוק את החלק של $b^2$.", "בדיקת $b^2$");
                 showQuadraticSection('diagnosticQuadQ2_sub_bSquared');
            } else { // -23, likely sign error in -4ac or subtraction
                 displayQuadraticFeedback("התוצאה אינה $-23$. ייתכן שיש טעות בחישוב $4ac$ או בפעולת החיסור. בוא נבדוק את $4ac$.", "בדיקת $4ac$ וחיסור");
                 showQuadraticSection('diagnosticQuadQ2_sub_4ac');
            }
        }

        function checkDiagnosticQuadQ2_sub_bSquared() {
            const answer = getSelectedRadioValueQuadratic('diagQuadQ2_sub_bSqAnswer');
            if (!answer) { displayQuadraticFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReportQuadratic('diagnosticQuadQ2_sub_bSquared');
            const selectedOption = document.querySelector('input[name="diagQuadQ2_sub_bSqAnswer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentQuadraticPath.push({ type: 'attempt', stepDescription: "שלב 2.1: חישוב $b^2$", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === "25") {
                displayQuadraticFeedback("נכון, $(-5)^2 = 25$. כעת, בוא נחשב את $4ac$.", null);
                setTimeout(() => {
                    showQuadraticSection('diagnosticQuadQ2_sub_4ac');
                    document.getElementById('feedbackQuadraticSection').classList.add('hidden');
                }, 2500);
            } else {
                displayQuadraticFeedback("לא מדויק. $(-5)^2 = (-5) \\times (-5) = 25$. מספר שלילי בחזקת זוגית נותן תוצאה חיובית.", "חזקה של מספר שלילי");
                showQuadraticSection(null);
            }
        }

        function checkDiagnosticQuadQ2_sub_4ac() {
            const answer = getSelectedRadioValueQuadratic('diagQuadQ2_sub_4acAnswer');
            if (!answer) { displayQuadraticFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReportQuadratic('diagnosticQuadQ2_sub_4ac');
            const selectedOption = document.querySelector('input[name="diagQuadQ2_sub_4acAnswer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentQuadraticPath.push({ type: 'attempt', stepDescription: "שלב 2.2: חישוב $4ac$", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === "24") {
                displayQuadraticFeedback("נכון, $4ac = 4(1)(6) = 24$. כעת, נחזור לחישוב המלא של הדיסקרימיננטה: $\Delta = b^2 - 4ac$.", null);
                setTimeout(() => {
                    // Re-display the discriminant question, user should now be able to get it right
                    // Or, if we stored b^2, we can directly ask for b^2 - 4ac
                    document.getElementById('diagnosticQuadQ2_discriminantSection').querySelector('.question-text').innerHTML = 
                    `הדיסקרימיננטה נתונה על ידי $\Delta = b^2 - 4ac$.<br>מצאנו ש-$b^2=25$ וש-$4ac=24$. למה שווה $\Delta$?`;
                    queueMathJaxTypeset(document.getElementById('diagnosticQuadQ2_discriminantSection'));
                    showQuadraticSection('diagnosticQuadQ2_discriminantSection');
                    document.getElementById('feedbackQuadraticSection').classList.add('hidden');
                }, 3500);
            } else {
                displayQuadraticFeedback("לא מדויק. $4ac = 4 \\times 1 \\times 6 = 24$.", "כפל מספרים פשוט");
                showQuadraticSection(null);
            }
        }


        function checkDiagnosticQuadQ3_formula() {
            const answer = getSelectedRadioValueQuadratic('diagQuadQ3_formAnswer');
            if (!answer) { displayQuadraticFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReportQuadratic('diagnosticQuadQ3_formulaSection');
            const selectedOption = document.querySelector('input[name="diagQuadQ3_formAnswer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentQuadraticPath.push({ type: 'attempt', stepDescription: "שלב 3: שימוש בנוסחה", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });
            document.getElementById('feedbackQuadraticSection').classList.add('hidden');

            if (answer === correctFormulaExpression) { // "(5pm1)/2"
                displayQuadraticFeedback("הצבה נכונה בנוסחה! $\sqrt{1}=1$, לכן הביטוי הוא $\frac{5 \pm 1}{2}$. ממשיכים לחישוב השורשים.", null);
                setTimeout(() => {
                    showQuadraticSection('diagnosticQuadQ4_rootsSection');
                    document.getElementById('feedbackQuadraticSection').classList.add('hidden');
                }, 3000);
            } else if (answer === "(-5pm1)/2") {
                displayQuadraticFeedback("שים לב לסימן של $-b$. אם $b=-5$, אז $-b = -(-5) = 5$.", "הצבת $-b$ בנוסחה");
                showQuadraticSection(null);
            } else if (answer === "(5pm_sqrt_delta_error)/2") { // This option was meant to catch delta vs sqrt(delta)
                 displayQuadraticFeedback("כמעט. $\sqrt{\Delta} = \sqrt{1} = 1$. לכן הביטוי הוא $\frac{5 \pm 1}{2}$.", "חישוב $\sqrt{\Delta}$");
                 showQuadraticSection(null);
            } else { // (5pm1)/1 -- error in 2a
                displayQuadraticFeedback("שים לב למכנה $2a$. אם $a=1$, אז $2a = 2(1) = 2$.", "הצבת $2a$ בנוסחה");
                showQuadraticSection(null);
            }
        }

        function checkDiagnosticQuadQ4_roots() {
            const answer = getSelectedRadioValueQuadratic('diagQuadQ4_rootsAnswer');
            if (!answer) { displayQuadraticFeedback("אנא בחר תשובה.", null); return; }
            const questionReportText = getQuestionTextForReportQuadratic('diagnosticQuadQ4_rootsSection');
            const selectedOption = document.querySelector('input[name="diagQuadQ4_rootsAnswer"]:checked');
            const answerText = selectedOption ? (selectedOption.parentElement.textContent || selectedOption.parentElement.innerText).replace(/^[א-ד]\)\s*/, '').trim() : answer;
            studentQuadraticPath.push({ type: 'attempt', stepDescription: "שלב 4: חישוב שורשים", questionText: questionReportText, selectedAnswer: answer, selectedAnswerText: answerText });

            if (answer === "x1=3,x2=2") {
                displayQuadraticFeedback("כל הכבוד! הפתרונות $x=2, x=3$ נכונים. אם זו לא הייתה תשובתך לבעיה הראשית, בדוק היכן התרחשה הטעות בחישובים שלך.", "פתרון מלא של משוואה ריבועית");
                showQuadraticSection(null);
            } else if (answer === "x1=6,x2=4") {
                 displayQuadraticFeedback("נראה שחישבת נכון את המונים: $5+1=6$ ו-$5-1=4$. אבל אל תשכח לחלק כל תוצאה במכנה, שהוא $2$.", "חילוק במכנה בנוסחת השורשים");
                 showQuadraticSection(null);
            } else { // x1=2.5,x2=1.5
                 displayQuadraticFeedback("טעות בחישוב. $x_1 = \frac{5+1}{2} = \frac{6}{2} = 3$. ו-$x_2 = \frac{5-1}{2} = \frac{4}{2} = 2$.", "חישוב סופי של השורשים");
                 showQuadraticSection(null);
            }
        }

    </script>
</body>
</html>
